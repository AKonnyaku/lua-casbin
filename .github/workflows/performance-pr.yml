name: Performance Comparison for Pull Requests

on:
  pull_request:
    branches: [master]

jobs:
  benchmark-pr:
    name: Performance benchmark comparison
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Lua
        uses: leafo/gh-actions-lua@v10
        with:
          luaVersion: "5.3"

      - name: Setup LuaRocks
        uses: leafo/gh-actions-luarocks@v4

      - name: Install dependencies
        run: |
          luarocks install luasocket
          luarocks make

      - name: Save commit info
        id: commits
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          echo "base_short=${BASE_SHA:0:7}" >> $GITHUB_OUTPUT
          echo "head_short=${HEAD_SHA:0:7}" >> $GITHUB_OUTPUT

      - name: Run benchmark on PR branch
        run: |
          lua bench.lua | tee pr-bench.txt

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.sha }}
          path: base

      - name: Run benchmark on base branch
        working-directory: base
        run: |
          # Re-install deps for base if needed, or rely on global rocks
          # Usually global rocks work. But we need to make sure 'casbin' rock is built from source if bench uses it.
          # bench.lua requires "src.main.Enforcer" relative to PWD usually.
          # Let's check bench.lua: local Enforcer = require("src.main.Enforcer")
          # It uses local paths. So we just need luasocket.
          lua bench.lua | tee ../base-bench.txt

      - name: Compare benchmarks
        id: benchstat
        run: |
          cat > comparison.md << 'EOF'
          ## Benchmark Comparison

          Comparing base branch (`${{ steps.commits.outputs.base_short }}`)
          vs PR branch (`${{ steps.commits.outputs.head_short }}`)

          ```
          EOF
          
          # Python script to parse results and generate table
          python3 - <<'PY' >> comparison.md
          import sys
          import re
          import platform
          import math

          # 1. Parse functions
          def parse_bench_file(filename):
              data = {}
              try:
                  with open(filename, 'r') as f:
                      for line in f:
                          # Parse: Name: \tTotal ops = N \tTime per op = X.XXXX ms
                          # Regex to capture Name and Time
                          # Example: Raw: 	Total ops = 10000 	Time per op = 0.0012 ms
                          m = re.search(r'^(.*?):\s+Total ops = \d+\s+Time per op = ([\d\.]+) ms', line)
                          if m:
                              name = m.group(1).strip()
                              ms_val = float(m.group(2))
                              ns_val = ms_val * 1e6 # Convert ms to ns
                              data[name] = {"cpu_time": ns_val}
              except FileNotFoundError:
                  pass
              return data

          base = parse_bench_file("base-bench.txt")
          pr = parse_bench_file("pr-bench.txt")

          all_keys = sorted(list(set(base.keys()) | set(pr.keys())))

          # 2. Helpers
          def fmt_ns(val_ns):
              if val_ns == 0: return "0"
              if val_ns >= 1e9: return f"{val_ns/1e9:.3f}s"
              if val_ns >= 1e6: return f"{val_ns/1e6:.3f}m"
              if val_ns >= 1e3: return f"{val_ns/1e3:.3f}Âµ"
              return f"{val_ns:.3f}n"

          # Get CPU info
          cpu_info = "Unknown CPU"
          try:
              if platform.system() == "Linux":
                  with open("/proc/cpuinfo", "r") as f:
                      for line in f:
                          if "model name" in line:
                              cpu_info = line.split(":", 1)[1].strip()
                              break
          except: pass

          print(f"goos: {platform.system().lower()}")
          print(f"goarch: {platform.machine().lower()}")
          print(f"pkg: lua-casbin")
          print(f"cpu: {cpu_info}")
          
          # Table Headers
          # Col 1: 50 chars (Name)
          # Col 2: 19 chars (base)
          # Col 3: 19 chars (pr)
          # Col 4: 27 chars (stats)
          # Col 5: 9 chars (delta)
          
          # Line 1
          print(f"{'':<50} â”‚ {'base-bench.txt':^19} â”‚ {'pr-bench.txt':^47} â”‚")
          # Line 2: Note the column widths for data rows are 50, 19, 19, 27, 9
          # The header "pr-bench.txt" spans the last 3 cols? 
          # In the example:
          # â”‚ /tmp/base-bench.txt â”‚           /tmp/pr-bench.txt           â”‚
          # â”‚       sec/op        â”‚    sec/op      vs base                â”‚   Delta
          # The second line headers align with data columns.
          # Data cols: Name(50) Val1(19) Val2(19) Stats(27) Delta(9)
          # Total width right of Name: 19+3 + 19+3 + 27+3 + 9 = ?
          # Actually let's look at the example separators.
          # " â”‚ " is 3 chars.
          # Name(50) "   " Val1(19) "   " Val2(19) "   " Stats(27) "   " Delta(9)
          # Wait, the example has "â”‚" separators in header but spaces in body.
          # Header 1:
          # Space(50) " â”‚ " Title1(19) " â”‚ " Title2(47) " â”‚"
          # 19 + 3 + 27 = 49? No.
          # The example snippet:
          # â”‚ /tmp/base-bench.txt â”‚           /tmp/pr-bench.txt           â”‚
          # â”‚       sec/op        â”‚    sec/op      vs base                â”‚   Delta
          #
          # Let's try to match the columns:
          # Col 1: 50 spaces
          # Col 2: base-bench (19)
          # Col 3+4: pr-bench (matches PR val + Stats?)
          # PR Val (19) + Gap (3) + Stats (27) = 49.
          # So Title2 width 49? 
          # My previous code used 47. Let's adjust.
          # 19 + 3 + 27 = 49.
          # So Header 1:
          # print(f"{'':<50} â”‚ {'base-bench.txt':^19} â”‚ {'pr-bench.txt':^49} â”‚")
          
          # Header 2:
          # print(f"{'':<50} â”‚ {'sec/op':^19} â”‚ {'sec/op':^19} {'vs base':<27} â”‚   Delta")
          
          print(f"{'':<50} â”‚ {'base-bench.txt':^19} â”‚ {'pr-bench.txt':^49} â”‚")
          print(f"{'':<50} â”‚ {'sec/op':^19} â”‚ {'sec/op':^19} {'vs base':<27} â”‚   Delta")

          base_vals = []
          pr_vals = []

          for k in all_keys:
              b_item = base.get(k)
              p_item = pr.get(k)
              b_val = b_item.get("cpu_time", 0.0) if b_item else 0.0
              p_val = p_item.get("cpu_time", 0.0) if p_item else 0.0
              
              if b_val > 0: base_vals.append(b_val)
              if p_val > 0: pr_vals.append(p_val)
              
              if b_val > 0:
                  diff = (p_val - b_val) / b_val
                  diff_str = f"{diff:+.2%}"
                  if diff < -0.10: status = "ðŸš€"
                  elif diff > 0.10: status = "ðŸŒ"
                  else: status = "âž¡ï¸"
              else:
                  diff_str = "-"
                  status = ""
              
              b_str = (fmt_ns(b_val) + " Â± âˆž Â¹") if b_val else "-"
              p_str = (fmt_ns(p_val) + " Â± âˆž Â¹") if p_val else "-"
              
              stats = "~ (p=1.000 n=1) Â²"
              
              display_name = k
              
              # Data row alignment
              if b_val > 0 and p_val > 0:
                   print(f"{display_name:<50}   {b_str:>19}   {p_str:>19}   {stats:<27}   {diff_str:>9} {status}")
              else:
                   print(f"{display_name:<50}   {b_str:>19}   {p_str:>19}   {'':<27}   {diff_str:>9} {status}")

          def get_geomean(vals):
              if not vals: return 0.0
              return math.exp(sum(math.log(x) for x in vals) / len(vals))

          g_base = get_geomean(base_vals)
          g_pr = get_geomean(pr_vals)
          
          g_diff_str = "-"
          g_status = ""
          if g_base > 0 and g_pr > 0:
              diff = (g_pr - g_base) / g_base
              g_diff_str = f"{diff:+.2%}"
              if diff < -0.10: g_status = "ðŸš€"
              elif diff > 0.10: g_status = "ðŸŒ"
              else: g_status = "âž¡ï¸"
          
          g_b_str = fmt_ns(g_base) if g_base > 0 else "-"
          g_p_str = fmt_ns(g_pr) if g_pr > 0 else "-"
          
          # Geomean row alignment
          print(f"{'geomean':<50}   {g_b_str:>19}   {g_p_str:>19}   {'':<27}   {g_diff_str:>9} {g_status}")
          
          print("Â¹ need >= 6 samples for confidence interval at level 0.95")
          print("Â² need >= 4 samples to detect a difference at alpha level 0.05")
          PY
          
          echo '```' >> comparison.md

      - name: Save PR number
        run: echo ${{ github.event.number }} > pr_number.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            comparison.md
            pr_number.txt
